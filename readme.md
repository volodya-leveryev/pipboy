# Чат-бот «Помощник куратора»

## Таблица пользователей

Таблица пользователей позволяет чат-боту знать пользователей.

Администратор системы имеет доступ для редактирования таблицы пользователей.

В таблице пользователей имеются колонки:

* Номер пользователя в Telegram
* Логин пользователя в Telegram
* Номер телефона
* Администратор - признак того что пользователь администратор системы
* ФИО
* Обращение - как чат-бот обращается к пользователю (Галина Михайловна, Петр)
* Идентификатор чата в котором бот общается с пользователем

Пользователи должны написать боту. В момент начала общения бот должен запросить:

* ФИО
* Учебное подразделение
* Учебную группу

Далее бот должен получить у ответственного по группе разрешить на добавление студента.

Также в базе данных должны быть таблицы, которые позволяют определить

* в каких группах и подгруппах состоит пользователь
* для каких групп данный пользователь может рассылать сообщения и 
  опросы

## Таблица объявлений

Таблица объявлений позволяет чат-боту отправлять пользователям по их запросу заготовленные объявления. Например сведения о том как получить справку об учебе.

В таблице с объявлениями имеются колонки:

* Категория
* Заголовок
* Текст
* Ключевые слова

## Как чат-бот общается с пользователями

Администратор может скомандовать боту перечитать таблицу пользователей или таблицу объявлений.

Чат-бот общается только с пользователями, которых знает по таблице пользователей.

Пользователи могут просматривать объявления из таблицы объявлений по категориям.

Пользователи могут искать объявления из таблицы объявлений по ключевым словам.

Куратор может разослать пользователям по своим группам сообщения, файлы, фото, аудио.

Куратор видит прочитали ли пользователи сообщение или нет (по возможности в зависимости от настроек приватности пользователя).

Куратор может за запустить опрос пользователей с контролем ответа.
- ответы да / нет
- текстовый ответ
- загрузка файла

Чат-бот выдает информацию о расписании на текущую неделю для группы с учетом четности недели.

## Как чат-бот работает внутри

Таблицы пользователей и объявлений скачиваются из Google Sheets в формате CSV и хранятся в объектном хранилище (бакете). Хранение таблиц в Google Sheets позволяет обойтись без админки.

Чат-бот работает в режиме Webhook, на бессерверном сервисе Cloud Functions в облаке Яндекса. Это позволяет обойтись без хостинга и сократить расходы на инфраструктуру.

Чат-бот хранит данные о прочитанности сообщений пользователями в Redis.

Чат-бот хранит данные об ответах на опросы пользователей в Redis.

## Предложения для второй версии

Админка для управления пользователями.

Платные подписки для организаций.

Регистрация пользователя с помощью кодового слова и заполнения краткой анкеты.

Данные о пользователях нужно хранить в СУБД.

## Запросы от пользователя

Данные из ЛК (оценки, прикрепление курсовых, отчетов практики, электронные ведомости)

Вход в личный кабинет???

Связать с расписанием

Отслеженивание выполнения квот???

## Тестовый запуск

* Создать и активировать виртуальное окружение
* Установить библиотеки `pip install -r requirements.txt`
* Отключить Yandex Cloud Function чтобы избежать конфликта
* Найти в базе данных YDB параметры соединения и задать переменные окружения
  - `YDB_ENDPOINT` (вида grpcs://ydb.serverless.yandexcloud.net:2135)
  - `YDB_DATABASE` (вида /<id зоны доступности>/<id облака>/<id базы данных>)
* Задать переменную окружения `BOT_TOKEN`
* Войти в сервисный аккаунт и создать авторизованный ключ
* Задать переменную окружения `SA_KEY_FILE` и указать путь к этому ключу
* Запустить `python bot.py`

## Литература

* [Пример на Telegraf в Яндекс Сloud Functions](https://cloud.yandex.ru/docs/functions/tutorials/telegram-bot-serverless)
* [API Telegram](https://core.telegram.org/)

**Фреймворки**

* [JavaScript (Telegraf)](https://telegrafjs.org/)
* [Python Telegram Bot](https://docs.python-telegram-bot.org/en/v20.0a4/)
* [pyTelegramBotAPI (Telebot)](https://pytba.readthedocs.io/en/latest/index.html)

**API**

* [Telegram API](https://telegram-bot-sdk.readme.io/reference/)
